<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/prism-element/prism-highlighter.html">
<link rel="import" href="../bower_components/prism-element/prism-theme-default.html">
<link rel="import" href="../bower_components/sanitize-element/sanitize-element.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage-multiupload.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage-upload-task.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage-ref.html">

<!-- https://poly-style.appspot.com?id=github-markdown-styles&url=https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.min.css -->
<link rel="import" href="my-theme.html">

<dom-module id="my-marked">
  <template>
    <style include="prism-theme-default my-theme">
      :host {
        display: block;
        margin: 10px 15px;
        --paper-input-container: {
          width: 100%;
        }
      }
      paper-toggle-button {
        margin-top: 15px;
      }
    </style>

    <firebase-storage-multiupload
      path="/files" upload-tasks="{{uploadTasks}}"></firebase-storage-multiupload>
    <template is="dom-repeat" items="[[uploadTasks]]">
      <firebase-storage-upload-task task="[[item]]" metadata="{{_metaData}}"></firebase-storage-upload-task>
    </template>

    <firebase-storage-ref path="[[path]]" download-url="{{downloadUrl}}"></firebase-storage-ref>
    
    <prism-highlighter></prism-highlighter>

    <sanitize-element
      sanitizer="{{_sanitizer}}"
      config='{"elements":["my-home","img"],
               "attributes":{"img":["class","src"]},
               "protocols":{"img":{"src":["https"]}}}'></sanitize-element>
    
    <marked-element sanitize sanitizer="[[_sanitizer]]" markdown="[[contents]]" on-marked-loadend="_sync">
      <main class="markdown-body" slot="markdown-html"></main>
      <script type="text/markdown" src$="[[downloadUrl]]"></script>
    </marked-element>
    
    <template is="dom-if" if="[[path]]">
      <template is="dom-if" if="[[login]]">
        <paper-toggle-button checked="{{_edit}}"></paper-toggle-button>
        <paper-textarea value="{{contents}}" hidden="[[!_edit]]"
                        on-drop="_onDrop" on-paste="_onPaste"></paper-textarea>
        <paper-button on-tap="_save" hidden="[[!_edit]]">SAVE</paper-button>
      </template>
    </template>
    
  </template>
  <script>
    class MyMarked extends Polymer.Element {
      static get is() { return 'my-marked' }
      static get properties() {
        return {
          key: String,
          login: Boolean,
          path: {
            type: String,
            computed: '_computedPath(key)'
          },
          downloadUrl: String,
          allowedTypes: {
            type: Array,
            value: [
              'image/jpeg',
              'image/png',
              'image/jpg',
              'image/gif'
            ]
          },
          progressText: {
            type: String,
            value: '![Uploading file...]()'
          },
          _metaData: {
            type: Object,
            observer: '_metaDataChanged'
          }
        }
      }
      _sync(){
        this.contents=this.shadowRoot.querySelector('marked-element').markdown
      }
      _save(){
        this.shadowRoot.querySelector('firebase-storage-ref').putString(this.contents)
      }
      _computedPath(key){
        return key ? '/files/'+key+'.md' : null
      }
      _onDrop(e){
        e.stopPropagation()
        e.preventDefault()
        this.shadowRoot.querySelector('firebase-storage-multiupload').upload(
          Array.from(e.dataTransfer.files)
               .filter(f=>this.allowedTypes.indexOf(f.type) !== -1)
               .map(f=>{this._insertImageText(this.progressText); return f;}))
      }
      _onPaste(e){
        this.shadowRoot.querySelector('firebase-storage-multiupload').upload(
          Array.from(e.clipboardData.items || e.clipboardData.files || [])
               .filter(f=>this.allowedTypes.indexOf(f.type) !== -1)
               .map(i=>{this._insertImageText(this.progressText); return i.getAsFile();}))
      }
      _metaDataChanged(meta){
        if(meta) this._insertImageText('!['+meta.name+']('+meta.downloadURLs[0]+')'+"\n")
      }
      _insertImageText(text){
        const el = this.shadowRoot.querySelector('paper-textarea')
                       .shadowRoot.querySelector('iron-autogrow-textarea')
        const pos = el.selectionStart
        const ptext = this.progressText
        let offset = 0
        if(this.contents.substr(pos - ptext.length, ptext.length) == ptext)
          offset = ptext.length
        this.contents = this.contents.substring(0, pos - offset) + text +
                        this.contents.substring(pos, this.contents.length)
        el.selectionStart = pos + text.length - offset
        el.selectionEnd = pos + text.length - offset
        el.focus()
      }
    }
    customElements.define(MyMarked.is, MyMarked)
  </script>
</dom-module>
