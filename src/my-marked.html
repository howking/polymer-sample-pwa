<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/prism-element/prism-highlighter.html">
<link rel="import" href="../bower_components/prism-element/prism-theme-default.html">
<link rel="import" href="../bower_components/sanitize-element/sanitize-element.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage-ref.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage-multiupload.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage-upload-task.html">

<!-- https://poly-style.appspot.com?id=github-markdown-styles&url=https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.min.css -->
<link rel="import" href="my-theme.html">
<link rel="import" href="my-ia.html">

<dom-module id="my-marked">
  <template>
    <style include="prism-theme-default my-theme">
      :host {
        display: block;
        margin: 10px 15px;
        --paper-input-container: {
          width: 100%;
        }
      }
      paper-toggle-button {
        margin-top: 15px;
      }
    </style>

    <!--
    <firebase-storage-ref
      path="/files/p-logo.png"
      download-url="{{downloadUrl}}"></firebase-storage-ref>
    -->

    <firebase-storage-multiupload
      id="fs"
      path="/files"
      upload-tasks="{{uploadTasks}}"
      files="[[files]]"></firebase-storage-multiupload>
    <template is="dom-repeat" items="[[uploadTasks]]">
      <firebase-storage-upload-task
        task="[[item]]""
        bytes-transferred="{{item.bytesTransferred}}"
        total-bytes="{{item.totalBytes}}"
        state="{{item.state}}"
        download-url="{{_downloadUrl}}"
        metadata="{{item.metadata}}"
        path="{{item.path}}"></firebase-storage-upload-task>
      <img src="{{item.downloadUrl}}" style="width: 36px;">
    </template>

    <prism-highlighter></prism-highlighter>

    <sanitize-element
      sanitizer="{{_sanitizer}}"
      config='{"elements":["my-home","img"],
               "attributes":{"img":["class","src"]},
               "protocols":{"img":{"src":["https"]}}}'></sanitize-element>
    
    <marked-element sanitize sanitizer="[[_sanitizer]]" markdown="[[contents]]">
      <main class="markdown-body" slot="markdown-html"></main>
    </marked-element>
    
    <template is="dom-if" if="[[contents]]">
      <template is="dom-if" if="[[login]]">
        <paper-toggle-button checked="{{_edit}}"></paper-toggle-button>
        <paper-textarea value="{{contents}}" hidden="[[!_edit]]"></paper-textarea>
      </template>
    </template>
      
  </template>
  <script>
    class MyMarked extends Polymer.Element {
      static get is() { return 'my-marked' }
      static get properties() {
        return {
          login: Boolean,
          contents: {
            type: String,
            notify: true
          },
          files: {
            type: Array,
            notify: true,
            value: []
          },
          _downloadUrl:{
            type: String,
            observer: "_insertDownloadUrl"
          }
        }
      }
      static get observers() {
        return ['editview(_edit)']
      }
      editview(_edit){
        if(_edit && ! this._initEdit){
          this._initEdit = true
          const textarea = this.shadowRoot.querySelector('paper-textarea')
          //inlineAttachment.editors.input.attachToInput(textarea,{uploadUrl:'imageUrl'})
          console.log('edit')

          textarea.addEventListener('drop', e=>{
            e.stopPropagation()
            e.preventDefault()
            this._onDrop(e)
          })
        }
      }
      _onDrop(e){
        this.shadowRoot.querySelector('#fs').upload(e.dataTransfer.files)
      }
      _upload(e) {
        this.files = e.target.files;
        console.log(this.files)
      }
      _insertDownloadUrl(text){
        if(text){
          text='![img]('+text+')'
          const textarea = this.shadowRoot.querySelector('paper-textarea')
          var strPos = textarea.shadowRoot.querySelector('iron-autogrow-textarea').selectionStart
          var front = this.contents.substring(0, strPos)
          var back = this.contents.substring(strPos, this.contents.length)
          this.contents = front + text + back
        }
      }
    }
    customElements.define(MyMarked.is, MyMarked)
  </script>
</dom-module>
