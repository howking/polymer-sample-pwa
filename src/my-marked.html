<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/prism-element/prism-highlighter.html">
<link rel="import" href="../bower_components/prism-element/prism-theme-default.html">
<link rel="import" href="../bower_components/sanitize-element/sanitize-element.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage-multiupload.html">
<link rel="import" href="../bower_components/polymerfire/firebase-storage-upload-task.html">

<!-- https://poly-style.appspot.com?id=github-markdown-styles&url=https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.min.css -->
<link rel="import" href="my-theme.html">

<dom-module id="my-marked">
  <template>
    <style include="prism-theme-default my-theme">
      :host {
        display: block;
        margin: 10px 15px;
        --paper-input-container: {
          width: 100%;
        }
      }
      paper-toggle-button {
        margin-top: 15px;
      }
    </style>

    <firebase-storage-multiupload
      path="/files" upload-tasks="{{uploadTasks}}"></firebase-storage-multiupload>
    <template is="dom-repeat" items="[[uploadTasks]]">
      <firebase-storage-upload-task
        task="[[item]]" download-url="{{_downloadUrl}}"></firebase-storage-upload-task>
    </template>

    <prism-highlighter></prism-highlighter>

    <sanitize-element
      sanitizer="{{_sanitizer}}"
      config='{"elements":["my-home","img"],
               "attributes":{"img":["class","src"]},
               "protocols":{"img":{"src":["https"]}}}'></sanitize-element>
    
    <marked-element sanitize sanitizer="[[_sanitizer]]" markdown="[[contents]]">
      <main class="markdown-body" slot="markdown-html"></main>
    </marked-element>
    
    <template is="dom-if" if="[[contents]]">
      <template is="dom-if" if="[[login]]">
        <paper-toggle-button checked="{{_edit}}"></paper-toggle-button>
        <paper-textarea value="{{contents}}" hidden="[[!_edit]]"
                        on-drop="_onDrop" on-paste="_onPaste"></paper-textarea>
      </template>
    </template>
    
  </template>
  <script>
    class MyMarked extends Polymer.Element {
      static get is() { return 'my-marked' }
      static get properties() {
        return {
          login: Boolean,
          contents: {
            type: String,
            notify: true
          },
          _downloadUrl:{
            type: String,
            observer: "_downloadUrlChanged"
          }
        }
      }
      _onDrop(e){
        e.stopPropagation()
        e.preventDefault()
        this.shadowRoot.querySelector('firebase-storage-multiupload').upload(e.dataTransfer.files)
      }
      _onPaste(e){
        if (typeof e.clipboardData === "object")
          this.shadowRoot.querySelector('firebase-storage-multiupload').upload(
            Array.from(e.clipboardData.items || e.clipboardData.files || []).map(i=>i.getAsFile()))
      }
      _downloadUrlChanged(url){
        if(url){
          const textarea = this.shadowRoot.querySelector('paper-textarea')
          const el= textarea.shadowRoot.querySelector('iron-autogrow-textarea')
          const pos = el.selectionStart
          const text = "![img]("+url+")\n"
          this.contents = this.contents.substring(0, pos) + text + this.contents.substring(pos, this.contents.length)
          el.selectionStart = pos + text.length
        }
      }
    }
    customElements.define(MyMarked.is, MyMarked)
  </script>
</dom-module>
